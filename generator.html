<!doctype html><html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="Author" content="Erki Suurjaak" />
  <title>Flag Trading Cards | Generator</title>
  <script src="http://code.jquery.com/jquery.min.js"></script>
  <style id="stylesheet">
  <!--
    body { font-family: Calibri; }
    #cards {
      clear: both;
    }
    div.card {
      position: relative;
      width: 200px;
      height: 300px;
      padding: 5px;
      float: left;
      margin: 5px;
      border: 1px solid black;
      border-radius: 2px;
    }
    img.flag {
      margin-left: auto;
      margin-right: auto;
      display: block;
      border: 0px;
      box-shadow: 1px 1px 3px #888;
      max-width: 170px;
      max-height: 100px;
    }
    img.heraldic {
      position: absolute;
      bottom: 5px;
      right: 5px;
      max-height: 50px;
    }
    img.heraldic.small {
      max-height: 30px;
    }
    .hideHeraldic img.heraldic {
      display: none;
    }
    div.card h1 {
      font-size: 1em;
      text-align: center;
      padding: 0px;
      margin: 0px;
      font-weight: normal;
      text-transform: uppercase;
    }
    div.card dl {
      font-size: 0.7em;
      margin: 1em 0 0 0;
    }
    dt {
      width: 48%;
      font-weight: bold;
      float: left;
    }
    dt.shifted {
      position: relative;
      top: 3px;
    }
    dd {
      width: 45%;
      margin: 0px;
      float: left;
    }
    dd:after { /* add linebreak, dd is inline */
      content: "\a";
      white-space: pre;
    }
    span.index {
      color: #DDD;
      font-size: 0.6em;
      position: absolute;
      bottom: 0px;
      left: 3px;
    }
    #header {
      text-align: center;
    }
    #footer table {
     max-width: 600px;
     margin-left: auto;
     margin-right: auto;
    }
    #footer {
      clear: both;
      font-size: 0.8em;
      padding-top: 20px;
    }
    #footer tr {
      vertical-align: top;
    }
    #footer th {
      text-align: left;
      white-space: nowrap;
    }
    #footer p { text-align: center; }
  -->
  </style>
  <link rel="shortcut icon" type="image/png" id="favicon" href="data:image/png;base64,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" />
</head>
<script type="text/javascript">
<!--

var WIKIPEDIA_API_URL = "http://en.wikipedia.org/w/api.php?callback=?";

var NAMED_COLOURS = {"aliceblue": "#f0f8ff", "antiquewhite": "#faebd7", "aqua": "#00ffff", "aquamarine": "#7fffd4", "azure": "#f0ffff", "beige": "#f5f5dc", "bisque": "#ffe4c4", "black": "#000000", "blanchedalmond": "#ffebcd", "blue": "#0000ff", "blueviolet": "#8a2be2", "brown": "#a52a2a", "burlywood": "#deb887", "cadetblue": "#5f9ea0", "chartreuse": "#7fff00", "chocolate": "#d2691e", "coral": "#ff7f50", "cornflowerblue": "#6495ed", "cornsilk": "#fff8dc", "crimson": "#dc143c", "cyan": "#00ffff", "darkblue": "#00008b", "darkcyan": "#008b8b", "darkgoldenrod": "#b8860b", "darkgray": "#a9a9a9", "darkgreen": "#006400", "darkkhaki": "#bdb76b", "darkmagenta": "#8b008b", "darkolivegreen": "#556b2f", "darkorange": "#ff8c00", "darkorchid": "#9932cc", "darkred": "#8b0000", "darksalmon": "#e9967a", "darkseagreen": "#8fbc8f", "darkslateblue": "#483d8b", "darkslategray": "#2f4f4f", "darkturquoise": "#00ced1", "darkviolet": "#9400d3", "deeppink": "#ff1493", "deepskyblue": "#00bfff", "dimgray": "#696969", "dodgerblue": "#1e90ff", "firebrick": "#b22222", "floralwhite": "#fffaf0", "forestgreen": "#228b22", "fuchsia": "#ff00ff", "gainsboro": "#dcdcdc", "ghostwhite": "#f8f8ff", "gold": "#ffd700", "goldenrod": "#daa520", "gray": "#808080", "green": "#008000", "greenyellow": "#adff2f", "honeydew": "#f0fff0", "hotpink": "#ff69b4", "indianred": " #cd5c5c", "indigo": " #4b0082", "ivory": "#fffff0", "khaki": "#f0e68c", "lavender": "#e6e6fa", "lavenderblush": "#fff0f5", "lawngreen": "#7cfc00", "lemonchiffon": "#fffacd", "lightblue": "#add8e6", "lightcoral": "#f08080", "lightcyan": "#e0ffff", "lightgoldenrodyellow": "#fafad2", "lightgray": "#d3d3d3", "lightgreen": "#90ee90", "lightpink": "#ffb6c1", "lightsalmon": "#ffa07a", "lightseagreen": "#20b2aa", "lightskyblue": "#87cefa", "lightslategray": "#778899", "lightsteelblue": "#b0c4de", "lightyellow": "#ffffe0", "lime": "#00ff00", "limegreen": "#32cd32", "linen": "#faf0e6", "magenta": "#ff00ff", "maroon": "#800000", "mediumaquamarine": "#66cdaa", "mediumblue": "#0000cd", "mediumorchid": "#ba55d3", "mediumpurple": "#9370db", "mediumseagreen": "#3cb371", "mediumslateblue": "#7b68ee", "mediumspringgreen": "#00fa9a", "mediumturquoise": "#48d1cc", "mediumvioletred": "#c71585", "midnightblue": "#191970", "mintcream": "#f5fffa", "mistyrose": "#ffe4e1", "moccasin": "#ffe4b5", "navajowhite": "#ffdead", "navy": "#000080", "oldlace": "#fdf5e6", "olive": "#808000", "olivedrab": "#6b8e23", "orange": "#ffa500", "orangered": "#ff4500", "orchid": "#da70d6", "palegoldenrod": "#eee8aa", "palegreen": "#98fb98", "paleturquoise": "#afeeee", "palevioletred": "#db7093", "papayawhip": "#ffefd5", "peachpuff": "#ffdab9", "peru": "#cd853f", "pink": "#ffc0cb", "plum": "#dda0dd", "powderblue": "#b0e0e6", "purple": "#800080", "red": "#ff0000", "rosybrown": "#bc8f8f", "royalblue": "#4169e1", "saddlebrown": "#8b4513", "salmon": "#fa8072", "sandybrown": "#f4a460", "seagreen": "#2e8b57", "seashell": "#fff5ee", "sienna": "#a0522d", "silver": "#c0c0c0", "skyblue": "#87ceeb", "slateblue": "#6a5acd", "slategray": "#708090", "snow": "#fffafa", "springgreen": "#00ff7f", "steelblue": "#4682b4", "tan": "#d2b48c", "teal": "#008080", "thistle": "#d8bfd8", "tomato": "#ff6347", "turquoise": "#40e0d0", "violet": "#ee82ee", "wheat": "#f5deb3", "white": "#ffffff", "whitesmoke": "#f5f5f5", "yellow": "#ffff00", "yellowgreen": "#9acd32"}
var REGEX_COLOUR_SHORTHEX = /^#[0-9a-f]{3}$/ig;
var REGEX_COLOUR = new RegExp("^(#[0-9a-f]{3}|#[0-9a-f]{6}|" +
  Object.keys(NAMED_COLOURS).join("|") + 
  "|((rgba*|hsla*)\\((\\s*[0-9.%]+\\s*,){2,3}\\s*[0-9.%]*\\s*\\)))$", "i");
var REGEX_COLOURS = new RegExp("[^-a-z0-9](#[0-9a-f]{3}|#[0-9a-f]{6}|" +
  Object.keys(NAMED_COLOURS).join("|") + 
  "|((rgba*|hsla*)\\((\\s*[0-9.%]+\\s*,){2,3}\\s*[0-9.%]*\\s*\\)))[^-a-z0-9]", "ig");
var REGEX_COLOUR_TUPLE = new RegExp("(^(rgba*|hsla*)\\(\\s*([0-9.%]+)\\s*,\\s*([0-9.%]+)\\s*,\\s*([0-9.%]+)\\s*,*\\s*[0-9.%]*\\s*\\)$)", "i");

// Regex for matching countries where flag should not have box shadow border.
var REGEX_COUNTRIES_NOBORDER = new RegExp("Nepal", "i");

var REGEX_COUNTRIES_TOSKIP = new RegExp("^((?!(georg|hong|macau|puerto)).)*$", "i"); // @todo remove when done
var REGEX_COUNTRIES_TOSKIP = new RegExp("Crimea|Abkhazia", "i");

/** List of countries to include additionally. */
var COUNTRIES_EXTRA = ["Hong Kong", "Macau", "Puerto Rico"];

var KNOWN_HERALDIC_URLS = {"Canada": "http://upload.wikimedia.org/wikipedia/en/4/4f/Coat_of_arms_of_Canada.svg" };
// Some countries do not have SVG images, or parsing yields false results.
var BLANK_IMG = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";

// Some values are hard to parse from Wikipedia, or missing altogether
var KNOWN_VALUES = {
  "Area": {"South Korea": 100210, "Taiwan": 35883, "Vatican City": 0.44},
  "Capital": {"Monaco": "Monaco", "Singapore": "Singapore", "Vatican City": "Vatican City"},
  "Capital population": {"Cook Islands": 13373, "Nauru": 1292, "Singapore": "", "Vatican City": ""},
  "Obesity rate": {"Afghanistan": 2.2, "Albania": 21.3, "Algeria": 16.0, "American Samoa": 74.6, "Andorra": 25.2, "Angola": 6.4, "Antigua and Barbuda": 25.6, "Argentina": 29.7, "Armenia": 24.0, "Australia": 26.8, "Austria": 20.9, "Azerbaijan": 23.8, "Bahamas": 34.7, "Bahrain": 32.9, "Bangladesh": 3.5, "Barbados": 34.7, "Belarus": 24.3, "Belgium": 22.1, "Belize": 33.7, "Benin": 6.0, "Bhutan": 5.3, "Bolivia": 17.9, "Bosnia and Herzegovina": 26.5, "Botswana": 11.2, "Brazil": 18.8, "Brunei": 7.5, "Bulgaria": 23.7, "Burkina Faso": 2.3, "Burma": 4.0, "Burundi": 2.9, "Cape Verde": 10.0, "Cambodia": 2.1, "Cameroon": 10.3, "Canada": 26.2, "Central African Republic": 3.5, "Chad": 2.7, "Chile": 29.4, "China": 5.7, "Colombia": 17.3, "Comoros": 4.4, "Democratic Republic of the Congo": 1.7, "Republic of the Congo": 4.7, "Cook Islands": 63.7, "Costa Rica": 23.7, "Ivory Coast": 6.2, "Croatia": 24.2, "Cuba": 21.5, "Cyprus": 25.5, "Czech Republic": 32.7, "Denmark": 18.2, "Djibouti": 9.4, "Dominica": 24.9, "Dominican Republic": 21.2, "Ecuador": 21.4, "Egypt": 33.1, "El Salvador": 25.8, "Equatorial Guinea": 10.6, "Eritrea": 1.5, "Estonia": 20.6, "Ethiopia": 1.1, "Fiji": 30.6, "Finland": 23.0, "France": 18.2, "Gabon": 13.9, "The Gambia": 7.9, "Georgia": 22.1, "Germany": 25.1, "Ghana": 7.5, "Greece": 20.1, "Grenada": 22.5, "Guatemala": 19.2, "Guinea": 4.4, "Guinea-Bissau": 4.9, "Guyana": 17.2, "Haiti": 7.9, "Honduras": 18.4, "Hungary": 27.6, "Iceland": 23.2, "India": 1.9, "Indonesia": 4.8, "Iran": 19.4, "Iraq": 27.0, "Republic of Ireland": 25.2, "Israel": 26.2, "Italy": 19.8, "Jamaica": 24.1, "Japan": 5.0, "Jordan": 30.0, "Kazakhstan": 23.7, "Kenya": 4.2, "Kiribati": 46.0, "North Korea": 3.9, "South Korea": 7.7, "Kuwait": 42.0, "Kyrgyzstan": 15.5, "Laos": 2.6, "Latvia": 24.9, "Lebanon": 27.4, "Lesotho": 14.6, "Liberia": 4.8, "Libya": 27.8, "Lithuania": 27.6, "Luxembourg": 26.0, "Republic of Macedonia": 21.1, "Madagascar": 1.6, "Malawi": 4.3, "Malaysia": 14.0, "Maldives": 12.9, "Mali": 4.3, "Malta": 28.8, "Marshall Islands": 45.4, "Mauritania": 12.7, "Mauritius": 18.5, "Mexico": 32.1, "Federated States of Micronesia": 40.6, "Moldova": 21.2, "Mongolia": 14.4, "Montenegro": 22.5, "Morocco": 16.4, "Mozambique": 4.9, "Namibia": 9.5, "Nauru": 71.1, "Nepal": 1.4, "Kingdom of the Netherlands": 18.8, "New Zealand": 28.3, "Nicaragua": 22.2, "Niger": 2.4, "Nigeria": 6.5, "Norway": 21.5, "Oman": 20.9, "Pakistan": 5.5, "Palau": 48.9, "Panama": 25.4, "Papua New Guinea": 16.2, "Paraguay": 17.9, "Peru": 15.7, "Philippines": 6.3, "Poland": 25.3, "Portugal": 24.0, "Qatar": 33.2, "Romania": 19.1, "Russia": 26.5, "Rwanda": 4.3, "Saint Kitts and Nevis": 40.7, "Saint Lucia": 21.4, "Saint Vincent and the Grenadines": 23.4, "Samoa": 54.1, "São Tomé and Príncipe": 9.5, "Saudi Arabia": 33.0, "Senegal": 6.8, "Serbia": 24.8, "Seychelles": 23.9, "Sierra Leone": 6.8, "Singapore": 7.1, "Slovakia": 25.4, "Slovenia": 28.6, "Solomon Islands": 30.0, "Somalia": 4.8, "South Africa": 31.3, "Spain": 26.6, "Sri Lanka": 5.1, "Sudan": 6.0, "Suriname": 25.1, "Swaziland": 19.7, "Sweden": 18.6, "Switzerland": 17.5, "Syria": 27.1, "Tajikistan": 8.6, "Tanzania": 5.0, "Thailand": 8.8, "East Timor": 2.7, "Togo": 4.3, "Tokelau": 63.4, "Tonga": 57.6, "Trinidad and Tobago": 29.3, "Tunisia": 22.3, "Turkey": 27.8, "Turkmenistan": 13.2, "Uganda": 4.3, "Ukraine": 21.3, "United Arab Emirates": 32.7, "United Kingdom": 26.9, "United States": 33.0, "Uruguay": 24.8, "Uzbekistan": 15.1, "Vanuatu": 27.5, "Venezuela": 30.3, "Vietnam": 1.7, "Yemen": 14.5, "Zambia": 3.6, "Zimbabwe": 7.0},
  "Life expectancy": {"Montenegro": "74.5 (71.5M 77.5F)", "Swaziland": "50 (49M 51F)"},
  "Flag colours": {"Albania": 2, "Belgium": 3, "Botswana": 3, "Ghana": 4, "Iraq": 4, "Jamaica": 3, "Jordan": 4, "Kuwait": 4, "Malawi": 3, "State of Palestine": 4, "Saint Lucia": 4, "Somaliland": 4, "United Arab Emirates": 4, "Yemen": 3 },
  "Heraldic colours": {"Albania": 3, "Bosnia and Herzegovina": 3, "Cook Islands": 10, "Cyprus": 3, "Dominica": 8, "Grenada": 14, "Lebanon": 4, "Libya": 1, "Marshall Islands": 4, "Nigeria": 9, "South Africa": 11, "São Tomé and Príncipe": 10},
  "Title": {"Hong Kong": "Hong Kong Special Administrative Region of the PRC", "Macau": "Macau Special Administrative Region of the PRC"}
};

/** Formats number with thousand separator char. */
var formatNumber = function (val, sep) {
  sep = (typeof(sep) == "undefined") ? " " : sep;
  var parts = val.toString().replace(/,/g, "").trim().split(".");
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, sep);
  return parts.join(".");
};
var FORMATTERS = {
  "default": function(v) { return ("" + v).trim(); },
  "GDP per capita": function(v) { return (v.length > 1 && v.indexOf("$") < 0 ? "$" : "") + formatNumber(v); },
  "Population density": function(v) { return formatNumber(v) + " / km<sup><small>2</small></sup>"; },
  "Area": function(v) { return formatNumber(v) + " km<sup><small>2</small></sup>"; },
  "Population": function(v) { return formatNumber(v); },
  "Obesity rate": function(v) { return (v != "-") ? v.toFixed(1) : v; }
};


var actionCounter = 0; // For keeping track of queries and completion
var actionTotal = 0;


/** Adds the number of colours to template, counting all colour values in SVG url. */
var addColourValue = function(name, country, template, url) {
  template.find("dl").append($("<dt />").html(name), $("<dd />"));
  var element = template.find("dd:last");
  var value = "-";
  var svg_url = "";

  if (KNOWN_VALUES[name] && KNOWN_VALUES[name][country]) {
    value = KNOWN_VALUES[name][country];
  } else {
    if (url.match(/svg/i)) {
      // Example: //upload.wikimedia..../thumb/.../Greater_coat_of_arms_of_Georgia.svg/85px-Greater_coat_of_arms_of_Georgia.svg.png
      url = "http://" + url.replace(/^(https*\:)*\/+/, "");
      svg_url = url.replace(/\.svg\/(.+)$/, ".svg").replace("/thumb/", "/");
    }
  }

  if (svg_url) {
    var actionId = registerAction();
    $.get(svg_url,
      success=function(svg) {
        var colourMap = {};

        $(svg).find("*").each(function() {
          // Check any attributes for colour-like values
          if (this.nodeName.match(/sodipodi:namedview/i)) return; // Root element values not really used
          var lookups = []; // All potential values to check for colour
          $.each(this.attributes, function(_, node) {
            if (node.name.match(/(id)|(href)/i)) return; // Can have colour-like values
            if (node.name.match(/style/i)) {
              $.each(node.value.split(";"), function(_, item) {
                var namevalue = item.split(":");
                (2 == namevalue.length) ? lookups.push(namevalue[1]) : 0;
              });
            } else {
              lookups.push(node.value);
            }
          });
          if ("style" == this.nodeName) {
            // A separate CSS section: parse colours from style text
            var m = this.textContent.replace(/\/\*(\r|\n|.)*\*\//g, "").match(REGEX_COLOURS);
            var colours = (m || []).map(function(x) { return x.replace(/[^#a-z0-9]/ig, ""); });
            lookups = lookups.concat(colours);
          }
          lookups.map(function(x) { var c = parseColour(x.trim()); if (c) colourMap[c] = true; } );
        })
        element.html(Object.keys(colourMap).length || 1);
        if (name.match(/Flag/i)) {
          template.find("img.flag").attr("title", Object.keys(colourMap).sort().join(", "));
        }
        if (name.match(/Heraldic/i)) {
          template.find("img.heraldic").attr("title", Object.keys(colourMap).sort().join(", "));
        }
        unregisterAction(actionId);
      }
    ).error(function(e) {
      $("#errors").append("Get " + svg_url + ": " + e + "\n\n");
      element.html("-");
      unregisterAction(actionId);
    });
  } else {
    element.html(value);
  }
};


/** Adds the value to template, or the default value if value function fails. */
var addValue = function(name, country, template, valuefunc) {
  var result = undefined;
  var value = "-";
  if (KNOWN_VALUES[name] && country in KNOWN_VALUES[name]) {
    value = KNOWN_VALUES[name][country];
  } else {
    try {
      value = valuefunc() || value;
    } catch (e) { }
  }
  result = (FORMATTERS[name] || FORMATTERS["default"])(value);
  template.find("dl").append($("<dt />").html(name), $("<dd />").html(result));
  if (result.match(/<sup>/i)) {
    template.find("dt:last").addClass("shifted");
  }
  return result;
};


/** Adds capital population to existing element, querying Wikipedia data. */
var addCapitalPopulation = function(capital, country, template) {
  var element = template.find("dt:contains('Capital')").next("dd");
  if (KNOWN_VALUES["Capital population"] && country in KNOWN_VALUES["Capital population"]) {
    element.append(", " + KNOWN_VALUES["Capital population"][country])
  } else {
    var actionId = registerAction();
    $.getJSON(WIKIPEDIA_API_URL,
      {
        "action": "parse",
        "disablepp": "1",
        "redirects": "1",
        "section": 0,
        "format": "json",
        "page": capital
      },
      function(data) {
        if (data.parse && data.parse.displaytitle) {
          // Bypass jQuery automatic image verification
          var p = $(data.parse.text["*"].replace(/<img[^>]+src=/g, function(a) { return a.substring(0, a.length - 1) + "hack="; } ));
          p.find("span[class*=sortkey]").remove(); // Invisible, interfere with parsing
          try {
            var value = ((p.find('th,td').filter(function(){ return $(this).text().match(/population/i); }).parent().next("tr").find("td:last-child").first().text().match(/([0-9.,\s]+)/i) || ["",""])[1] || (p.find('td').filter(function(){ return $(this).text().match(/population/i); }).next("td:first").text().match(/([0-9.,\s]+)/i) || ["",""])[1]).replace(/[.,]/g, " ").trim();
            if (value) element.append(", " + value)
          } catch (e) {
            $("#errors").append("Parse capital population " + capital + ": " + e + "\n\n");
          }
        }
        sizeHeraldicIcon(template);
        unregisterAction(actionId);
    }).error(function(e) {
      $("#errors").append("Query capital " + capital + ": " + e + "\n\n");
      unregisterAction(actionId);
    });
  }
};


/** Sizes the heraldic icon to fit under text, if necessary. */
var sizeHeraldicIcon = function(template) {
  setTimeout(function() {
    var dd_lastwide = template.find("dd").eq(-3);
    var img_heraldic = template.find("img.heraldic");
    var vspace = template.outerHeight() - dd_lastwide.position().top
                 - dd_lastwide.height() - (parseInt(img_heraldic.css("bottom")) || 0);
    if ((parseInt(img_heraldic.css("max-height")) || 0) > vspace) {
      img_heraldic.addClass("small");
    }
  }, 100);
};


/**
 * Returns colour hexadecimal parsed from value, or undefined if not colour.
 * Supports #0f0, #00ff00, green, rgb(0, 100%, 0.0) and hsl(120, 100%, 0.5).
 */
var parseColour = function(v) {
  var r = undefined;
  if (v && v.match(REGEX_COLOUR)) {
    r = v.toLowerCase();
    if (v.match(REGEX_COLOUR_SHORTHEX)) { // Convert #abc to #aabbcc
      r = "#" + v[1] + v[1] + v[2] + v[2] + v[3] + v[3];
    } else {
      var m = v.match(REGEX_COLOUR_TUPLE);
      if (m) { // Parse rgb|rgba|hsl|hsla colour tuple like rgb(0.5, 255, 100%)
        var MAX = v.indexOf("rgb") >= 0 ? 255 : 360;
        var tuple = m.slice(3, 6).map(function(x) {
          var n = (parseInt(x) || 0) % (MAX + 1);
          if (parseFloat(x) != parseInt(x)) {
            n = (parseFloat(x) * MAX) % (MAX + 1);
          } else if (x.indexOf("%") > 0) {
            n = ((parseInt(x) || 0) / 100 * MAX) % (MAX + 1);
          }
          return n;
        });
        if (v.indexOf("hsl") >= 0) tuple = hslToRgb.apply(this, tuple);
        r = "#" + tuple.map(function(x) { return (x + 256).toString(16).substr(-2); }).join("");
      }
    }
    r = NAMED_COLOURS[r] || r;
  }
  return r;
};


/** Makes a new card from country info page. */
var makeCard = function(displaytitle, page, template) {
  // Avoid jQuery automatic image verifying
  var p = $(page.replace(/<img[^>]+src=/g, function(a) { return a.substring(0, a.length - 1) + "hack="; } ));
  template.attr("data-name", displaytitle);

  var capital = undefined;
  var flag_svg_url = null;
  var heraldic_svg_url = null;

  var flag_url = p.find("img[srchack*=Flag_of]:first").attr("srchack").replace(/svg\/(\d+)px/, "svg/180px") || "";
  var heraldic_url = KNOWN_HERALDIC_URLS[displaytitle] || p.find("img").filter(function() { return $(this).attr("srchack").match(/Coats*_of_arms|Emblem|Seal_of|Koninklijk|Bundesadler|Armoiries|Staatswappen|Arms_of|Escudo_|Herb_|_COA|coa_|-arms/i); }).first().attr("srchack") || "";

  if (displaytitle in KNOWN_VALUES["Title"]) {
    title = KNOWN_VALUES["Title"][displaytitle];
  } else {
    p.find("span[class='fn org country-name']:first").find("a").remove(); // Name-span can contain superfluous links
    var title = p.find("span[class='fn org country-name']:first").text()
    if (displaytitle.length > title.length) { // Go with the longer defined name
      title = displaytitle;
    }
    title = title.replace(/\s\(country\)/i, ""); // Entries like "Georgia (country)"
  }

  if (flag_url) flag_url = "http://" + flag_url.replace(/^(https*\:)*\/+/, "");
  if (heraldic_url) heraldic_url = "http://" + heraldic_url.replace(/^(https*\:)*\/+/, "");

  template.find("img.flag").attr("src", flag_url);
  var heraldic_icon = heraldic_url ? heraldic_url.replace(/svg\/(\d+)px/, "svg/50px") : BLANK_IMG;
  template.find("img.heraldic").attr("src", heraldic_icon);

  template.find("a").attr("href", "http://en.wikipedia.com/wiki/" + displaytitle.replace(/ /g, "_"));
  if (displaytitle.match(REGEX_COUNTRIES_NOBORDER)) {
    template.find("img.flag").attr("style", "box-shadow: none;");
  }
  template.find("h1").html(title);

  addValue("Area", displaytitle, template, function() { return $("<span />").html(
      (p.find('th,td').filter(function(){ return $(this).text().toLowerCase() === "area"; }).parent().next("tr").find("th:last,td:last").html().match(/([0-9 ,.]+).*km/) || p.find('th,td').filter(function(){ return $(this).text().toLowerCase() === "area"; }).next("th,td").html().match(/([0-9 ,.]+).*km/))[1]
    ).text(); }
  );

  addValue("Population", displaytitle, template, function() { return $("<span />").html(
      p.find("th,td").filter(function(){ return $(this).text().toLowerCase() === "population"; }).parent().next("tr").find("td:last").text().match(/([0-9,.\s]+)/)[1]
    ).text(); }
  );

  addValue("Population density", displaytitle, template, function() { return $("<span />").html(
      p.find("th,td").filter(function(){ return $(this).text().toLowerCase() === "population"; }).parent().parent().find("th,td").filter(function(){ return $(this).text().match(/^Density/i); }).next().text().match(/([0-9.,\s]+).*\/km/i)[1]
    ).text(); }
  );

  var capitalDisambig = []; // Need non-ambiguous Wikipedia title for population lookup
  capital = addValue("Capital", displaytitle, template, function() { 
      var elem = p.find('th,td').filter(function(){ return $(this).text().match(/^Capital/i); }).next("th,td").find("a[title]").filter(function(){ return $(this).text() && !$(this).attr("title").match(/de jure/i); }).first();
      if (elem) {
        capitalDisambig.push(elem.attr("title"));
      } else {
        elem = p.find('th,td').filter(function(){ return $(this).text().match(/^Capital/i); }).next("th,td").find("span[class*=nowrap]").first();
      }
      var value = $("<span />").html(elem.text().trim()).text().replace(/[()]/g, "");
      capitalDisambig.push(value);
      return value;
    }
  );
  var capitalPage = capitalDisambig && capitalDisambig[0] ? capitalDisambig[0] : capital;
  if (capitalPage && capitalPage != "-") {
    addCapitalPopulation(capitalPage, displaytitle, template);
  }

  addValue("GDP per capita", displaytitle, template, function() { return $("<span />").html(
      p.find('th,td').filter(function(){ return $(this).text().match(/gdp\s*\(nominal\)/i); }).parent().next("tr").next("tr").find("th:last,td:last").html().match(/([$\s0-9a-z.,]+)<*/i)[1]
    ).text(); }
  );

  addValue("Life expectancy", displaytitle, template);
  addValue("Obesity rate", displaytitle, template);

  var letters = "state " + title.replace(/\s/, "").length;
  if (capital != "-") {
    letters += ", capital " + capital.replace(/\s/, "").length;
  }
  template.find("dl").append($("<dt />").html("Letters"), $("<dd />").html(letters));

  addColourValue("Heraldic colours", displaytitle, template, heraldic_url);
  addColourValue("Flag colours", displaytitle, template, flag_url);
  sizeHeraldicIcon(template);
};


/** Makes new cards for the countries, querying Wikipedia data. */
var makeCountries = function(countries) {
  var basetemplate = $("#template").remove();
  basetemplate.removeAttr("id");
  basetemplate.find("img").attr({"src": "", "title": ""});
  basetemplate.find("h1,dl,span").empty();
  var index = 0;
  for (var i in countries) {
    var country = countries[i];
    if (country.match(REGEX_COUNTRIES_TOSKIP)) continue; // continue for countries
    index++;
    var template = basetemplate.clone().appendTo($("#cards"));
    template.find("h1").html(country);
    template.find(".index").html(index);

    (function(country, template) {
      var actionId = registerAction();
      $.getJSON(WIKIPEDIA_API_URL,
        {
          "action": "parse",
          "disablepp": "1",
          "redirects": "1",
          "section": 0,
          "format": "json",
          "page": country
        },
        function(data) {
          if (data.parse && data.parse.displaytitle) {
            try {
              var displaytitle = $("<span />").html(data.parse.displaytitle).text().replace(/[ _]\(country\)$/i, "");
              makeCard(displaytitle, data.parse.text["*"], template);
            } catch (e) {
              $("#errors").append("makeCard (" + country + "): " + e + "\n\n");
            }
          } else {
            template.remove();
          }
          unregisterAction(actionId);
      }).error(function(e) {
        $("#errors").append("Query " + country + ": " + e + "\n\n");
        template.remove();
        unregisterAction(actionId);
      });
    })(country, template);
  }
};


/** Generates a full country card list, querying Wikipedia data. */
var generateCards = function() {
  $("#generate").attr("disabled", "disabled");
  $("#cards").find("div:not([id])").remove();
  $("#savelink").html("Creating..");

  var DATAQUERIES = {
    "GDP per capita": {
      "page": "GDP (PPP) per capita",
      "val": function(x) { return x.find("td").eq(2).text(); },
      "key": function(x) { return x.find("a:first").attr("title"); },
      "filter": function() { return $(this).find("td").length; }},
    "Life expectancy": {
      "page": "life expectancy",
      "val": function(x) { 
        var format = function(v) { return parseFloat(v).toFixed(1); };
        var total = x.find("td").eq(3).text(), m = x.find("td").eq(4).text(), f = x.find("td").eq(5).text();
        return format(total) + (!(m && f) ? "" : " (" + format(m) + "M, " + format(f) + "F)");
      },
      "key": function(x) { return x.find("a:first").attr("title"); },
      "filter": function() { return $(this).find("a:first").attr("title"); }},
    "Population density": {
      "page": "population density",
      "val": function(x) { return x.find("td").eq(6).text(); },
      "key": function(x) { return x.find("a:first").text(); },
      "filter": function() { return $(this).find("td:first").text(); } }
  };
  for (var valuename in DATAQUERIES) {
    (function(valuename, query) {
      var actionId = registerAction();
      $.getJSON(WIKIPEDIA_API_URL,
        {
          "action": "parse",
          "disablepp": "1",
          "redirects": "1",
          "format": "json",
          "prop": "text",
          "page": "List of countries by " + query.page
        },
        function(data) {
          if (!KNOWN_VALUES[valuename]) KNOWN_VALUES[valuename] = {};
          var p = $("<span />").html(data.parse.text["*"].replace(/<img[^>]+src=/g, function(a) { return a.substring(0, a.length - 1) + "hack="; } ));
          var tables = p.find("table.wikitable").sort(function(a,b) { return $(b).find("tr").length - $(a).find("tr").length; });
          $(tables[0]).find("tr").filter(query.filter).each(function() {
            var k = query.key($(this)).replace(/[ _]\(country\)$/i, "");
            var v = query.val($(this));
            if (v) KNOWN_VALUES[valuename][k] = v;
          });
          KNOWN_VALUES[valuename]["Kingdom of the Netherlands"] = KNOWN_VALUES[valuename]["Netherlands"];
          unregisterAction(actionId);
        }
      ).error(function(e) {
        $("#errors").append("Query general data: " + e + "\n\n");
        unregisterAction(actionId);
      });
    })(valuename, DATAQUERIES[valuename]);
  }

  var actionId = registerAction();
  $.getJSON(WIKIPEDIA_API_URL,
    {
      "action": "parse",
      "disablepp": "1",
      "redirects": "1",
      "format": "json",
      "prop": "text",
      "page": "List of countries"
    },
    function(data) { 
      if (data.parse && data.parse.text) {
        // Bypass jQuery automatic image verification
        var page = $(data.parse.text["*"].replace(/<img[^>]+src=/g, function(a) { return a.substring(0, a.length - 1) + "hack="; } ));
        var links = page.find("td:first-child > span[id]:first-child").parent().find("a");
        var titles = links.map(function() { return ($(this).attr("title") || ""); }).get();
        COUNTRIES_EXTRA.map(function(x) { 
          titles.indexOf(x) < 0 ? titles.push(x) : ""; 
        });
        var countries = titles.sort().filter(function(x) { return x && true; });

        makeCountries(countries);
      }
      unregisterAction(actionId);
    }
  ).error(function(e) {
    $("#errors").append("Query countries: " + e + "\n\n");
    unregisterAction(actionId);
  });
};


/** Returns a complete static page HTML of the current content. */
var getStaticPage = function() {
  var content = '<!doctype html>\n<html>\n<head>' +
    '<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />' +
    '<meta name="Author" content="Erki Suurjaak" />' +
    '<title>Flag Trading Cards</title>';
  content += document.getElementById("favicon").outerHTML;
  content += document.getElementById("stylesheet").outerHTML;
  content += "\n</head>\n<body>";
  content += document.getElementById("header").outerHTML;

  var cardsElem = document.getElementById("cards");
  var styleBackup = cardsElem.getAttribute("style");
  cardsElem.removeAttribute("style"); // Clear generator-page specific styles
  var cards = cardsElem.outerHTML;
  cardsElem.setAttribute("style", styleBackup);
  if ($("#cards").hasClass("hideHeraldic")) {
    var cardsDoc = $(cards);
    cardsDoc.find("img.heraldic").remove();
    cards = cardsDoc[0].outerHTML;
  }
  content += cards;

  var timestamp = function(d) {
    var a = [d.getDate(), d.getMonth() + 1, d.getYear() + 1900, d.getHours(), d.getMinutes(), d.getSeconds()];
    for (var i in a) {
      a[i] = (a[i] < 10 ? "0" : "") + a[i];
    }
    return a[0] + "." + a[1] + "." + a[2] + " " + a[3] + ":" + a[4] + ":" + a[5];
  }
  var footerBackup = document.getElementById("footer").innerHTML;
  document.getElementById("footer").innerHTML += "<p>Page generated " + timestamp(new Date()) + ".</p>";
  content += document.getElementById("footer").outerHTML;
  document.getElementById("footer").innerHTML = footerBackup;
  content += "</body>\n</html>";
  return content;
};


/** Returns a new action ID, used for keeping track of progress. */
var registerAction = function() {
  actionCounter++;
  actionTotal++;
  return actionTotal;
};


/** Unregisters the action and refreshes counters. */
var unregisterAction = function(actionId) {
  actionCounter--;
  if (actionCounter) {
    document.getElementById("savelink").innerHTML = ("Creating.. (" + (actionTotal - actionCounter) + " Wikipedia queries)");
  } else {
    makeDownloadLink(!actionCounter);
    document.getElementById("info").innerHTML = ("Generated " + document.getElementById("cards").children.length + " flag cards from " + actionTotal + " Wikipedia queries.");
    setTimeout(function() { alert("Generation complete!"); }, 200);
  }
};


/** Makes a link with current static content that can be saved to file. */
var makeDownloadLink = function() {
  if (!actionCounter) {
    var content = unescape(encodeURIComponent(getStaticPage())); // Make UTF-8
    var link = document.getElementById("savelink");
    link.href = "data:application/octet-stream;base64," + btoa(content);
    link.innerHTML = ("Save file (" + content.length + " bytes)").replace(/ /g, "&nbsp;");
  }
};


$(document).ready(function() {
  $("#generate").click(generateCards);
  $("#hide_heraldic_img").click(function() {
    $("#cards").toggleClass("hideHeraldic");
    if (actionTotal && !actionCounter) makeDownloadLink();
  });
});


/**
 * Converts an HSL color value to RGB. Conversion formula
 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
 * Assumes h, s, and l are contained in the set [0..1] or [0..360], and
 * returns r, g, and b in the set [0..255].
 *
 * @param   Number  h       The hue
 * @param   Number  s       The saturation
 * @param   Number  l       The lightness
 * @return  Array           The RGB representation
 * @from    http://stackoverflow.com/questions/2353211/hsl-to-rgb-color-conversion
 */
var hslToRgb = function(h, s, l){
  var r, g, b;
  if (h > 1) h /= 360;
  if (s > 1) s /= 360;
  if (l > 1) l /= 360;

  if (s == 0){
    r = g = b = l; // achromatic
  } else {
    function hue2rgb(p, q, t) {
      if (t < 0) t += 1;
      if (t > 1) t -= 1;
      if (t < 1/6) return p + (q - p) * 6 * t;
      if (t < 1/2) return q;
      if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
      return p;
    }

    var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
    var p = 2 * l - q;
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }

  return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
};


-->
</script>
<body>

<div id="header">
<h1>Flag Trading Cards</h1>
</div>

<div id="cards" style="margin-right: 250px;">

<div class="card" id="template">
  <span class="index">1</span>
  <a href="http://en.wikipedia.org/wiki/Estonia" target="_blank"><img class="flag" src="http://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Flag_of_Estonia.svg/170px-Flag_of_Estonia.svg.png" title="#000000, #4891d9, #ffffff" alt="" /></a>
  <img class="heraldic" src="http://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Coat_of_arms_of_Estonia.svg/50px-Coat_of_arms_of_Estonia.svg.png" title="#1f1a17, #3a75c3, #c51f3a, #efa900" alt="" />
  <h1>Republic of Estonia</h1>
  <dl>
    <dt class="shifted">Area</dt><dd>45 227 km<sup><small>2</small></sup></dd>
    <dt>Population</dt><dd>1 311 870</dd>
    <dt class="shifted">Density</dt><dd>29 / km<sup><small>2</small></sup></dd>
    <dt>Capital</dt><dd>Tallinn, 430 594</dd>
    <dt>GDP per capita</dt><dd>$18 127</dd>
    <dt>Life expectancy</dt><dd>76.1 (71M, 81.2F)</dd>
    <dt>Obesity rate</dt><dd>20.6</dd>
    <dt>Letters</dt><dd>state 17, capital 7</dd>
    <dt>Flag colours</dt><dd>4</dd>
    <dt>Heraldic colours</dt><dd>3</dd>
  </dl>
</div>

</div>

<div id="footer">
  <table><tr>
    <th>Play:</th><td>Shuffle and deal all cards. Player next to dealer leads the first round.</td>
  </tr><tr>
    <th>Each round:</th><td>Leader announces a field from their topmost card. <br />
    Player with the best score puts the trick under their deck and leads the next round. <br />
    If a player's card has no value in chosen field, leader must choose another field.
    </td>
  </tr><tr>
    <th>Compare:</th><td>Higher numbers are better, except for obesity rate.<br />
    If best values are equal, tied players include their next card.</td>
  </tr><tr>
    <th>Endgame:</th><td>With 3 cards or less, player can choose which card to use.</td>
  </tr><tr>
    <th>Game over:</th><td>When one player loses all cards. Or when last player remains.</td>
  </tr></table>
<p>&copy; 2014 Erki Suurjaak. Version 1.1.14, 18.03.2014.</p>
</div>

<pre id="errors" style="padding-top: 20px; font-size: 0.85em; color: #444;"></pre>

<div id="sidebar" style="width: 250px; position: fixed; right: 0px; top: 100px;">
  <input type="button" id="generate" value="Start" />
  <label for="hide_heraldic_img">
    <input type="checkbox" id="hide_heraldic_img" checked="checked" />Include heraldic icon
  </label>
  <p><a id="savelink" download="flags.html" title="Save as a static page"></a></p>
  <p id="info">Generate flag cards from online Wikipedia data.</p>
</div>

</body>
</html>
